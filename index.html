<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇÑ„Åï„Åó„ÅÑ‰πù‰πù„Ç´„Éº„Éâ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆË™øÊï¥ */
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .shake { animation: shake 0.5s; }
        body { touch-action: manipulation; background-color: #fff7ed; }
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„Å´„Çà„Çã„Ç¨„Çø„Å§„ÅçÈò≤Ê≠¢ */
        .scroll-stable { overflow-y: scroll; } 
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºË£ÖÈ£æ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fff7ed; }
        ::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #fb923c; }
    </style>
</head>
<body class="text-stone-700 font-sans select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- „Ç¢„Ç§„Ç≥„É≥ ---
        const IconBase = ({ children, className, onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconBase>;
        const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></IconBase>;
        const Languages = (props) => <IconBase {...props}><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const UserCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        
        // --- Data ---
        const kukuReadings = {
            1: ["„ÅÑ„Çì„ÅÑ„Å°„Åå „ÅÑ„Å°", "„ÅÑ„Çì„Å´„Åå „Å´", "„ÅÑ„Çì„Åï„Çì„Åå „Åï„Çì", "„ÅÑ„Çì„Åó„Åå „Åó", "„ÅÑ„Çì„Åî„Åå „Åî", "„ÅÑ„Çì„Çç„Åè„Åå „Çç„Åè", "„ÅÑ„Çì„Åó„Å°„Åå „Åó„Å°", "„ÅÑ„Çì„ÅØ„Å°„Åå „ÅØ„Å°", "„ÅÑ„Çì„Åè„Åå „Åè"],
            2: ["„Å´„ÅÑ„Å°„Åå „Å´", "„Å´„Å´„Çì„Åå „Åó", "„Å´„Åï„Çì„Åå „Çç„Åè", "„Å´„Åó„Åå „ÅØ„Å°", "„Å´„Åî „Åò„ÇÖ„ÅÜ", "„Å´„Çç„Åè „Åò„ÇÖ„ÅÜ„Å´", "„Å´„Åó„Å° „Åò„ÇÖ„ÅÜ„Åó", "„Å´„ÅØ„Å° „Åò„ÇÖ„ÅÜ„Çç„Åè", "„Å´„Åè „Åò„ÇÖ„ÅÜ„ÅØ„Å°"],
            3: ["„Åï„Çì„ÅÑ„Å°„Åå „Åï„Çì", "„Åï„Çì„Å´„Åå „Çç„Åè", "„Åï„Åñ„Çì„Åå „Åè", "„Åï„Çì„Åó „Åò„ÇÖ„ÅÜ„Å´", "„Åï„Çì„Åî „Åò„ÇÖ„ÅÜ„Åî", "„Åï„Å∂„Çç„Åè „Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„Åï„Çì„Åó„Å° „Å´„Åò„ÇÖ„ÅÜ„ÅÑ„Å°", "„Åï„Çì„Å± „Å´„Åò„ÇÖ„ÅÜ„Åó", "„Åï„Çì„Åè „Å´„Åò„ÇÖ„ÅÜ„Åó„Å°"],
            4: ["„Åó„ÅÑ„Å°„Åå „Åó", "„Åó„Å´„Åå „ÅØ„Å°", "„Åó„Åï„Çì „Åò„ÇÖ„ÅÜ„Å´", "„Åó„Åó „Åò„ÇÖ„ÅÜ„Çç„Åè", "„Åó„Åî „Å´„Åò„ÇÖ„ÅÜ", "„Åó„Çç„Åè „Å´„Åò„ÇÖ„ÅÜ„Åó", "„Åó„Åó„Å° „Å´„Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„Åó„ÅØ „Åï„Çì„Åò„ÇÖ„ÅÜ„Å´", "„Åó„Åè „Åï„Çì„Åò„ÇÖ„ÅÜ„Çç„Åè"],
            5: ["„Åî„ÅÑ„Å°„Åå „Åî", "„Åî„Å´ „Åò„ÇÖ„ÅÜ", "„Åî„Åï„Çì „Åò„ÇÖ„ÅÜ„Åî", "„Åî„Åó „Å´„Åò„ÇÖ„ÅÜ", "„Åî„Åî „Å´„Åò„ÇÖ„ÅÜ„Åî", "„Åî„Çç„Åè „Åï„Çì„Åò„ÇÖ„ÅÜ", "„Åî„Åó„Å° „Åï„Çì„Åò„ÇÖ„ÅÜ„Åî", "„Åî„ÅØ „Åó„Åò„ÇÖ„ÅÜ", "„Åî„Å£„Åè „Åó„Åò„ÇÖ„ÅÜ„Åî"],
            6: ["„Çç„Åè„ÅÑ„Å°„Åå „Çç„Åè", "„Çç„Åè„Å´ „Åò„ÇÖ„ÅÜ„Å´", "„Çç„Åè„Åï„Çì „Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„Çç„Åè„Åó „Å´„Åò„ÇÖ„ÅÜ„Åó", "„Çç„Åè„Åî „Åï„Çì„Åò„ÇÖ„ÅÜ", "„Çç„Åè„Çç„Åè „Åï„Çì„Åò„ÇÖ„ÅÜ„Çç„Åè", "„Çç„Åè„Åó„Å° „Åó„Åò„ÇÖ„ÅÜ„Å´", "„Çç„Åè„ÅØ „Åó„Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„Çç„Å£„Åè „Åî„Åò„ÇÖ„ÅÜ„Åó"],
            7: ["„Åó„Å°„ÅÑ„Å°„Åå „Åó„Å°", "„Åó„Å°„Å´ „Åò„ÇÖ„ÅÜ„Åó", "„Åó„Å°„Åï„Çì „Å´„Åò„ÇÖ„ÅÜ„ÅÑ„Å°", "„Åó„Å°„Åó „Å´„Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„Åó„Å°„Åî „Åï„Çì„Åò„ÇÖ„ÅÜ„Åî", "„Åó„Å°„Çç„Åè „Åó„Åò„ÇÖ„ÅÜ„Å´", "„Åó„Å°„Åó„Å° „Åó„Åò„ÇÖ„ÅÜ„Åè", "„Åó„Å°„ÅØ „Åî„Åò„ÇÖ„ÅÜ„Çç„Åè", "„Åó„Å°„Åè „Çç„Åè„Åò„ÇÖ„ÅÜ„Åï„Çì"],
            8: ["„ÅØ„Å°„ÅÑ„Å°„Åå „ÅØ„Å°", "„ÅØ„Å°„Å´ „Åò„ÇÖ„ÅÜ„Çç„Åè", "„ÅØ„Å°„Åï„Çì „Å´„Åò„ÇÖ„ÅÜ„Åó", "„ÅØ„Å°„Åó „Åï„Çì„Åò„ÇÖ„ÅÜ„Å´", "„ÅØ„Å°„Åî „Åó„Åò„ÇÖ„ÅÜ", "„ÅØ„Å°„Çç„Åè „Åó„Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„ÅØ„Å°„Åó„Å° „Åî„Åò„ÇÖ„ÅÜ„Çç„Åè", "„ÅØ„Å£„Å± „Çç„Åè„Åò„ÇÖ„ÅÜ„Åó", "„ÅØ„Å£„Åè „Åó„Å°„Åò„ÇÖ„ÅÜ„Å´"],
            9: ["„Åè„ÅÑ„Å°„Åå „Åè", "„Åè„Å´ „Åò„ÇÖ„ÅÜ„ÅØ„Å°", "„Åè„Åï„Çì „Å´„Åò„ÇÖ„ÅÜ„Åó„Å°", "„Åè„Åó „Åï„Çì„Åò„ÇÖ„ÅÜ„Çç„Åè", "„Åè„Åî „Åó„Åò„ÇÖ„ÅÜ„Åî", "„Åè„Çç„Åè „Åî„Åò„ÇÖ„ÅÜ„Åó", "„Åè„Åó„Å° „Çç„Åè„Åò„ÇÖ„ÅÜ„Åï„Çì", "„Åè„ÅØ „Åó„Å°„Åò„ÇÖ„ÅÜ„Å´", "„Åè„Åè „ÅØ„Å°„Åò„ÇÖ„ÅÜ„ÅÑ„Å°"]
        };

        // --- Services ---
        class SoundService {
            constructor() { this.ctx = null; }
            getContext() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) this.ctx = new AudioContext();
                }
                return this.ctx;
            }
            playCorrect() {
                const ctx = this.getContext(); if (!ctx) return;
                if (ctx.state === 'suspended') ctx.resume();
                const t = ctx.currentTime;
                const osc1 = ctx.createOscillator(); const gain1 = ctx.createGain();
                osc1.type = 'triangle'; osc1.frequency.setValueAtTime(660, t);
                gain1.gain.setValueAtTime(0.1, t); gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                osc1.connect(gain1); gain1.connect(ctx.destination); osc1.start(t); osc1.stop(t + 0.3);
                
                const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain();
                osc2.type = 'triangle'; osc2.frequency.setValueAtTime(1320, t + 0.1);
                gain2.gain.setValueAtTime(0.1, t + 0.1); gain2.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                osc2.connect(gain2); gain2.connect(ctx.destination); osc2.start(t + 0.1); osc2.stop(t + 0.5);
            }
            playWrong() {
                const ctx = this.getContext(); if (!ctx) return;
                if (ctx.state === 'suspended') ctx.resume();
                const t = ctx.currentTime;
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t + 0.15);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                osc.connect(gain); gain.connect(ctx.destination); osc.start(t); osc.stop(t + 0.3);
            }
            playStamp() {
                // „Éù„É≥„ÉÉ„Å®„ÅÑ„ÅÜÈü≥ÔºàÂ∞ë„Åó„Éî„ÉÉ„ÉÅÂ§âÂåñ„Çí„Å§„Åë„Å¶„Åã„Çè„ÅÑ„ÅèÔºâ
                const ctx = this.getContext(); if (!ctx) return;
                if (ctx.state === 'suspended') ctx.resume();
                const t = ctx.currentTime;
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(400, t); 
                osc.frequency.exponentialRampToValueAtTime(800, t + 0.1);
                gain.gain.setValueAtTime(0.2, t); 
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
                osc.connect(gain); gain.connect(ctx.destination); osc.start(t); osc.stop(t + 0.2);
            }
        }
        const soundService = new SoundService();

        // --- Logic ---
        const getReading = (dan, multiplier) => kukuReadings[dan][multiplier - 1];
        const generateQuestions = (dan, level) => {
            return [1, 2, 3, 4, 5, 6, 7, 8, 9].map(m => {
                const product = dan * m;
                let missingPart = level === 1 ? 'dan' : level === 2 ? 'multiplier' : 'product';
                let options = level === 1 ? [dan] : level === 2 ? [1,2,3,4,5,6,7,8,9] : [1,2,3,4,5,6,7,8,9].map(mul => dan * mul);
                return { dan, multiplier: m, product, missingPart, options };
            });
        };

        // --- Components ---
        
        // Ë¶™Âêë„ÅëÁÆ°ÁêÜÁîªÈù¢
        const ParentDashboard = ({ history, onClose, onDelete, onDeleteAll }) => {
            return (
                <div className="absolute inset-0 bg-white/95 z-50 flex flex-col p-6 animate-pop overflow-hidden">
                    <header className="flex justify-between items-center mb-6 pb-4 border-b-2 border-orange-100">
                        <div className="flex items-center gap-3">
                            <UserCircle className="w-8 h-8 text-orange-500" />
                            <h2 className="text-2xl font-bold text-stone-700">‰øùË≠∑ËÄÖÁî®ÔºöÂ≠¶Áøí„ÅÆ„Åç„Çç„Åè</h2>
                        </div>
                        <div className="flex gap-2">
                             {/* ‰∏ÄÊã¨ÂâäÈô§„Éú„Çø„É≥ */}
                             {history.length > 0 && (
                                <button onClick={onDeleteAll} className="px-4 py-2 bg-rose-100 text-rose-500 rounded-full font-bold hover:bg-rose-200 transition-colors flex items-center gap-1">
                                    <Trash2 className="w-4 h-4" /> ÂÖ®ÂâäÈô§
                                </button>
                            )}
                            <button onClick={onClose} className="px-6 py-2 bg-stone-500 text-white rounded-full font-bold hover:bg-stone-600">„Å®„Åò„Çã</button>
                        </div>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto">
                        {history.length === 0 ? (
                            <p className="text-stone-400 text-center py-10">„Åæ„Å†„Åç„Çç„Åè„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                        ) : (
                            <table className="w-full text-left border-collapse">
                                <thead className="sticky top-0 bg-white/95">
                                    <tr className="border-b-2 border-orange-200 text-stone-500 text-sm">
                                        <th className="py-2 px-2">Êó•ÊôÇ</th>
                                        <th className="py-2 px-2">ÂÜÖÂÆπ</th>
                                        <th className="py-2 px-2">„Çµ„Éù„Éº„Éà</th>
                                        <th className="py-2 px-2">ÂâäÈô§</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {history.slice().reverse().map((h, i) => (
                                        <tr key={h.id} className="border-b border-stone-100 hover:bg-orange-50/50">
                                            <td className="py-3 px-2 text-sm text-stone-400">
                                                {new Date(h.date).toLocaleDateString()}<br/>
                                                {new Date(h.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            </td>
                                            <td className="py-3 px-2">
                                                <span className="font-bold text-lg text-orange-600">{h.dan}„ÅÆ„Å†„Çì</span>
                                                <span className="ml-2 text-xs px-2 py-1 bg-orange-100 text-orange-600 rounded-full">Lv.{h.level}</span>
                                            </td>
                                            <td className="py-3 px-2 text-sm">
                                                <div className="flex gap-2">
                                                    {h.settings.isReadingVisible ? <span className="text-emerald-500">ÊñáÂ≠ó„ÅÇ„Çä</span> : <span className="text-stone-300">ÊñáÂ≠ó„Å™„Åó</span>}
                                                </div>
                                            </td>
                                            <td className="py-3 px-2 text-center">
                                                <button onClick={() => onDelete(h.id)} className="text-stone-300 hover:text-rose-500 p-2 rounded-full hover:bg-rose-50 transition-colors">
                                                    <Trash2 className="w-5 h-5" />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        };

        const Menu = ({ stamps, counts, onStart, onToggleStamp }) => {
            const [selDan, setSelDan] = useState(null);
            const dans = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const levels = [
                { lv: 1, label: '„É¨„Éô„É´ 1', desc: '„Åã„Åë„Çâ„Çå„Çã„Åã„Åö' },
                { lv: 2, label: '„É¨„Éô„É´ 2', desc: '„Åã„Åë„Çã„Åã„Åö' },
                { lv: 3, label: '„É¨„Éô„É´ 3', desc: '„Åì„Åü„Åà' },
            ];
            
            // --- Â§âÊõ¥ÁÇπ2: ÊÆµ„Ç≥„É≥„Éó„É™„Éº„ÉàÊôÇ„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Éû„ÉÉ„Éî„É≥„Ç∞ ---
            const danIcons = {
                1: 'üê∂', 2: 'üåà', 3: 'üêº', 
                4: 'üç≠', 5: 'üê∞', 6: 'üêª', 
                7: 'üå∑', 8: 'ü¶ä', 9: 'üëë'
            };

            // --- Â§âÊõ¥ÁÇπ1: „É¨„Éô„É´Âà•„Çπ„Çø„É≥„Éó„Éû„ÉÉ„Éî„É≥„Ç∞ ---
            const levelIcons = {
                1: 'üëç', 2: 'üéâ', 3: 'üíÆ'
            };

            const isDanComplete = (d) => levels.every(l => stamps[`${d}-${l.lv}`]);

            if (!selDan) {
                return (
                    <div className="flex flex-col items-center w-full max-w-md mx-auto p-6 space-y-8 animate-pop">
                        <header className="text-center">
                            <h1 className="text-5xl font-black text-orange-500 mb-2 drop-shadow-sm">„ÇÑ„Åï„Åó„ÅÑ‰πù‰πù„Ç´„Éº„Éâ</h1>
                            <p className="text-stone-400 font-bold">„Å©„ÅÆ„Å†„Çì„Çí „Çå„Çì„Åó„ÇÖ„ÅÜ„Åô„ÇãÔºü</p>
                        </header>
                        <div className="grid grid-cols-3 gap-4 w-full">
                            {dans.map(d => (
                                <button key={d} onClick={() => setSelDan(d)} 
                                    className={`aspect-square rounded-3xl border-4 text-4xl font-black transition-all flex flex-col items-center justify-center relative
                                        ${isDanComplete(d) ? 'bg-emerald-50 border-emerald-200 text-emerald-500' : 'bg-white border-orange-100 text-orange-400 shadow-lg active:scale-90 hover:border-orange-300'}`}
                                >
                                    {d}
                                    {/* Â§âÊõ¥ÁÇπ2„ÅÆÈÅ©Áî®: üíÆ„ÅÆ‰ª£„Çè„Çä„Å´ÊåáÂÆö„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫ */}
                                    {isDanComplete(d) && <span className="absolute text-6xl opacity-100 pointer-events-none select-none">{danIcons[d]}</span>}
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center w-full max-w-md mx-auto p-6 space-y-6 animate-pop">
                    <header className="text-center w-full relative mb-4">
                        <button onClick={() => setSelDan(null)} className="absolute left-0 top-1 text-stone-400 underline font-bold hover:text-orange-400">„ÇÇ„Å©„Çã</button>
                        <h1 className="text-5xl font-black text-orange-500">{selDan} „ÅÆ„Å†„Çì</h1>
                    </header>
                    <div className="flex flex-col gap-5 w-full">
                        {levels.map(l => {
                            const key = `${selDan}-${l.lv}`;
                            const isStamped = !!stamps[key];
                            const count = counts[key] || 0;
                            return (
                                <div key={l.lv} className={`relative p-1 rounded-[2rem] border-4 transition-all ${isStamped ? 'bg-emerald-50 border-emerald-300' : 'bg-white border-orange-100 shadow-lg'}`}>
                                    <div className="flex">
                                        <button onClick={() => onStart(selDan, l.lv)} className="flex-1 p-5 text-left active:opacity-70">
                                            <h3 className={`text-2xl font-black ${isStamped ? 'text-emerald-600' : 'text-stone-600'}`}>{l.label}</h3>
                                            <p className="text-stone-400 text-sm font-bold mb-1">{l.desc}</p>
                                            <div className="inline-block px-3 py-1 bg-stone-100 rounded-full text-xs font-bold text-stone-500">
                                                {count}„Åã„ÅÑ „Åß„Åç„ÅüÔºÅ
                                            </div>
                                        </button>
                                        <div className="w-24 border-l-2 border-dashed border-stone-100 flex flex-col items-center justify-center gap-1 p-2">
                                            <button 
                                                onClick={() => count > 0 && onToggleStamp(selDan, l.lv)}
                                                disabled={count === 0}
                                                className={`w-16 h-16 rounded-full flex items-center justify-center transition-all relative
                                                    ${count === 0 ? 'opacity-30 grayscale cursor-not-allowed bg-stone-100' : 'active:scale-110 active:bg-orange-50 bg-white shadow-sm border-2 border-orange-50'}
                                                `}
                                            >
                                                {/* Â§âÊõ¥ÁÇπ1„ÅÆÈÅ©Áî®: „É¨„Éô„É´„Åî„Å®„Å´„Çπ„Çø„É≥„Éó„ÇíÂ§â„Åà„Çã */}
                                                {isStamped ? (
                                                    <span className="text-4xl select-none animate-pop">{levelIcons[l.lv]}</span>
                                                ) : (
                                                    <div className="text-center"><div className="text-[10px] font-bold text-stone-400 leading-tight">„Åò„Åó„Çì„Åå<br/>„Å§„ÅÑ„Åü„Çâ<br/>„Åä„Åó„Å¶„Å≠</div></div>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const GameScreen = ({ dan, level, settings, onExit, onComplete }) => {
            const [qs, setQs] = useState([]);
            const [idx, setIdx] = useState(0);
            const [isDone, setIsDone] = useState(false);
            const [feedback, setFeedback] = useState('idle'); 

            useEffect(() => { setQs(generateQuestions(dan, level)); }, [dan, level]);

            const handleAns = (val) => {
                if (feedback !== 'idle') return;
                const q = qs[idx];
                const isCorrect = (q.missingPart === 'dan' && val === q.dan) || (q.missingPart === 'multiplier' && val === q.multiplier) || (q.missingPart === 'product' && val === q.product);
                
                if (isCorrect) {
                    setFeedback('correct');
                    if (settings.isSoundEnabled) soundService.playCorrect();
                    setTimeout(() => {
                        setFeedback('idle');
                        if (idx < qs.length - 1) setIdx(i => i + 1);
                        else { setIsDone(true); onComplete(); }
                    }, 1500);
                } else {
                    setFeedback('wrong');
                    if (settings.isSoundEnabled) soundService.playWrong();
                    setTimeout(() => setFeedback('idle'), 800);
                }
            };

            if (qs.length === 0) return null;

            if (isDone) {
                return (
                    // ÁµêÊûúÁîªÈù¢
                    <div className="flex flex-col items-center justify-center h-full p-8 text-center animate-pop">
                        <div className="mb-6 animate-bounce">
                             <div className="text-[8rem] select-none">üéâ</div>
                        </div>
                        <h2 className="text-5xl font-black text-orange-500 mb-4">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</h2>
                        <p className="text-xl font-bold text-stone-500 mb-8">„Åï„ÅÑ„Åî„Åæ„Åß „Åß„Åç„Åü„Å≠ÔºÅ</p>
                        
                        <div className="flex flex-col w-full gap-4 max-w-xs">
                            <button onClick={onExit} className="w-full py-4 bg-orange-400 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95 flex items-center justify-center hover:bg-orange-500 transition-colors">
                                <Home className="mr-2" /> „É°„Éã„É•„Éº„Å∏ „ÇÇ„Å©„Çã
                            </button>
                            <button onClick={() => { setIsDone(false); setIdx(0); }} className="w-full py-4 bg-white text-stone-500 border-2 border-stone-100 rounded-2xl font-bold text-xl active:scale-95 flex items-center justify-center hover:bg-stone-50 transition-colors">
                                <RefreshCw className="mr-2" /> „ÇÇ„ÅÜ„ÅÑ„Å°„Å©
                            </button>
                        </div>
                    </div>
                );
            }

            const q = qs[idx];
            const reading = getReading(q.dan, q.multiplier);
            const isSingleOption = q.options.length === 1; // ÈÅ∏ÊäûËÇ¢„Åå1„Å§Ôºà„É¨„Éô„É´1Ôºâ„Åã„Å©„ÅÜ„Åã

            const Part = ({ val, type }) => {
                const isMiss = q.missingPart === type;
                return (
                    <div className="w-20 h-20 md:w-32 md:h-32 flex items-center justify-center">
                        {isMiss ? (
                            <div className={`w-full h-full rounded-3xl border-4 flex items-center justify-center text-4xl md:text-7xl font-black transition-all duration-300
                                ${feedback === 'correct' ? 'border-emerald-400 text-emerald-500 bg-emerald-50' : 'border-orange-300 text-transparent bg-white border-dashed' }
                                ${feedback === 'wrong' ? 'border-rose-300 bg-rose-50 shake' : ''}`}>
                                {feedback === 'correct' ? val : '?'}
                            </div>
                        ) : (
                            <span className="text-5xl md:text-8xl font-black text-stone-700">{val}</span>
                        )}
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full p-6">
                    <div className="w-full bg-orange-100 h-3 rounded-full mb-8 overflow-hidden"><div className="bg-orange-400 h-full transition-all duration-500" style={{ width: `${(idx / qs.length) * 100}%` }} /></div>
                    <header className="flex justify-between items-center mb-6">
                        <button onClick={onExit} className="text-stone-300 hover:text-stone-500"><Home className="w-8 h-8" /></button>
                        <div className="px-4 py-1 bg-white border border-orange-100 rounded-full text-orange-400 font-bold">{idx + 1} / {qs.length}</div>
                    </header>
                    <main className="flex-1 flex flex-col items-center justify-center">
                        <div className="w-full bg-white rounded-[3rem] shadow-xl p-8 flex flex-col items-center justify-center mb-10 border-b-[8px] border-orange-50 relative min-h-[16rem]">
                            <div className="flex items-center justify-center gap-1 md:gap-4 mb-8 w-full">
                                <Part val={q.dan} type="dan" />
                                <span className="text-3xl md:text-5xl text-orange-200 font-black">√ó</span>
                                <Part val={q.multiplier} type="multiplier" />
                                <span className="text-3xl md:text-5xl text-orange-200 font-black">Ôºù</span>
                                <Part val={q.product} type="product" />
                            </div>
                            {settings.isReadingVisible && <div className="text-2xl md:text-4xl font-black text-orange-500 bg-orange-50 px-8 py-3 rounded-full animate-pop tracking-widest">{reading}</div>}
                        </div>
                        {/* ÈÅ∏ÊäûËÇ¢„Ç®„É™„Ç¢Ôºö1„Å§„ÅÆÂ†¥Âêà„ÅØFlex„Åß‰∏≠Â§ÆÂØÑ„Åõ„ÄÅË§áÊï∞„ÅÆÂ†¥Âêà„ÅØGrid */}
                        <div className={`w-full max-w-lg ${isSingleOption ? 'flex justify-center' : 'grid grid-cols-3'} gap-3 md:gap-4`}>
                            {q.options.map(opt => (
                                <button key={opt} onClick={() => handleAns(opt)} disabled={feedback !== 'idle'}
                                    className={`py-4 md:py-6 text-3xl md:text-4xl font-black bg-sky-400 text-white rounded-3xl border-b-4 border-sky-600 active:border-b-0 active:translate-y-1 active:scale-95 disabled:opacity-50 touch-manipulation shadow-md hover:bg-sky-500 transition-colors
                                        ${isSingleOption ? 'w-full max-w-[200px]' : ''} 
                                    `}
                                >
                                    {opt}
                                </button>
                            ))}
                        </div>
                    </main>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('MENU');
            const [currentDan, setCurrentDan] = useState(1);
            const [currentLevel, setCurrentLevel] = useState(1);
            const [showParentMenu, setShowParentMenu] = useState(false);

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('kuku_settings');
                // Èü≥Â£∞(Voice)„ÅÆË®≠ÂÆö„ÇíÂâäÈô§
                return saved ? JSON.parse(saved) : { isSoundEnabled: true, isReadingVisible: true };
            });
            const [stamps, setStamps] = useState(() => {
                const saved = localStorage.getItem('kuku_stamps');
                return saved ? JSON.parse(saved) : {}; 
            });
            const [counts, setCounts] = useState(() => {
                const saved = localStorage.getItem('kuku_counts');
                return saved ? JSON.parse(saved) : {};
            });
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('kuku_history');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => { localStorage.setItem('kuku_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('kuku_stamps', JSON.stringify(stamps)); }, [stamps]);
            useEffect(() => { localStorage.setItem('kuku_counts', JSON.stringify(counts)); }, [counts]);
            useEffect(() => { localStorage.setItem('kuku_history', JSON.stringify(history)); }, [history]);

            const handleComplete = (dan, level) => {
                const key = `${dan}-${level}`;
                setCounts(prev => ({ ...prev, [key]: (prev[key] || 0) + 1 }));
                setHistory(prev => [...prev, { id: Date.now(), date: Date.now(), dan, level, settings: { ...settings } }]);
            };

            const toggleStamp = (dan, level) => {
                const key = `${dan}-${level}`;
                const newState = !stamps[key];
                if (newState && settings.isSoundEnabled) soundService.playStamp();
                setStamps(prev => ({ ...prev, [key]: newState }));
            };

            const deleteHistoryItem = (id) => {
                if(confirm('„Åì„ÅÆ„Åç„Çç„Åè„Çí „Åë„Åó„Å¶„ÇÇ „ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü')) {
                    setHistory(prev => prev.filter(h => h.id !== id));
                }
            };

            const deleteAllHistory = () => {
                if(confirm('„Åª„Çì„Å®„ÅÜ„Å´ „Åô„Åπ„Å¶„ÅÆ„Åç„Çç„Åè„Çí „Åë„Åó„Å¶„ÇÇ „ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü')) {
                    setHistory([]);
                }
            };

            return (
                <div className="min-h-screen bg-orange-50 text-stone-700 font-sans p-0 md:p-8">
                    <div className="max-w-3xl mx-auto h-[100dvh] md:h-[90vh] flex flex-col bg-orange-50/50 md:bg-white md:shadow-2xl md:rounded-[3rem] overflow-hidden relative border-0 md:border-4 border-white">
                        
                        {/* Settings */}
                        <div className="absolute top-4 right-4 md:top-6 md:right-6 z-40 flex gap-2 md:gap-3">
                            <button onClick={() => setSettings(s => ({ ...s, isSoundEnabled: !s.isSoundEnabled }))}
                                className={`p-2 md:p-3 rounded-2xl border-2 transition-all ${settings.isSoundEnabled ? 'bg-white border-orange-200 text-orange-500 shadow-md' : 'bg-transparent border-stone-200 text-stone-300'}`}
                            >
                                {settings.isSoundEnabled ? <Volume2 className="w-5 h-5 md:w-6 md:h-6" /> : <VolumeX className="w-5 h-5 md:w-6 md:h-6" />}
                            </button>
                            {/* Â§âÊõ¥ÁÇπ3: „Çà„Åø„Åã„Åü„Éú„Çø„É≥„Çí„Çè„Åã„Çä„ÇÑ„Åô„ÅèË°®Á§∫ */}
                            <button onClick={() => setSettings(s => ({ ...s, isReadingVisible: !s.isReadingVisible }))}
                                className={`px-3 py-2 md:py-3 rounded-2xl border-2 transition-all flex items-center gap-1 ${settings.isReadingVisible ? 'bg-white border-orange-200 text-orange-500 shadow-md' : 'bg-transparent border-stone-200 text-stone-300'}`}
                            >
                                <Languages className="w-5 h-5 md:w-6 md:h-6" />
                                <span className="text-xs font-bold leading-none">„Çà„Åø„Åã„Åü</span>
                            </button>

                            <button onClick={() => setShowParentMenu(true)}
                                className="p-2 md:p-3 rounded-2xl border-2 border-stone-200 text-stone-300 bg-transparent hover:bg-stone-50 transition-all"
                            >
                                <UserCircle className="w-5 h-5 md:w-6 md:h-6" />
                            </button>
                        </div>

                        {showParentMenu && (
                            <ParentDashboard history={history} onClose={() => setShowParentMenu(false)} onDelete={deleteHistoryItem} onDeleteAll={deleteAllHistory} />
                        )}

                        {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢Ôºö„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„Ç¨„Çø„Å§„ÅçÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ scroll-stable „ÇØ„É©„Çπ‰ªò‰∏é */}
                        <div className="relative z-10 flex-1 flex flex-col h-full scroll-stable pt-16">
                            {gameState === 'MENU' ? (
                                <Menu stamps={stamps} counts={counts} 
                                    onStart={(d, l) => { setCurrentDan(d); setCurrentLevel(l); setGameState('PLAYING'); }} 
                                    onToggleStamp={toggleStamp}
                                />
                            ) : (
                                <GameScreen dan={currentDan} level={currentLevel} settings={settings} 
                                    onExit={() => setGameState('MENU')} 
                                    onComplete={() => handleComplete(currentDan, currentLevel)} 
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
